<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Butikskarta - Stabil Version</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- PapaParse för CSV inläsning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- SheetJS för riktig Excel-export (.xlsx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Turf.js för geografiska beräkningar (hitta kommun utifrån koordinat) -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        #map { height: 45vh; width: 100%; z-index: 1; }
        .sidebar { height: calc(100vh - 64px); overflow-y: auto; }
        .table-container { height: 50vh; overflow: auto; }
        
        .filter-section content { display: none; }
        .filter-section.active content { display: block; }
        .filter-section.active header svg { transform: rotate(180deg); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 antialiased overflow-hidden">

    <div id="loader" class="loading-overlay flex-col gap-4">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
        <p class="text-slate-600 font-medium italic text-lg text-center">
            Hämtar butiksregister...<br/>
            <span class="text-sm text-slate-400">Analyserar geografisk data för kommuner</span>
        </p>
    </div>

    <nav class="bg-slate-900 text-white h-16 px-6 flex items-center justify-between shadow-lg relative z-[1001]">
        <div class="flex items-center space-x-3">
            <div class="bg-blue-600 p-1.5 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                </svg>
            </div>
            <h1 class="text-lg font-bold tracking-tight uppercase italic">Butikskarta <span class="text-blue-400 font-light not-italic">Pro</span></h1>
        </div>
        <div class="flex items-center space-x-4">
            <div id="stats" class="hidden md:block text-sm font-medium bg-slate-800 px-4 py-1.5 rounded-full border border-slate-700 italic text-blue-300">
                Laddar...
            </div>
            <button id="downloadExcel" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-full text-xs font-bold transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Exportera Excel
            </button>
        </div>
    </nav>

    <div class="flex flex-col md:flex-row h-screen">
        <!-- Sidebar / Filter -->
        <aside class="w-full md:w-72 bg-white border-r border-slate-200 sidebar z-[1000]">
            <div class="p-4 space-y-6">
                
                <section>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block italic">Sök i registret</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Namn, kommun eller gata..." 
                            class="w-full border border-slate-200 rounded-lg pl-9 pr-3 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 top-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </section>

                <div class="space-y-3">
                    <!-- Kommun (Nytt filter) -->
                    <div class="filter-section active border border-slate-100 rounded-lg overflow-hidden" id="section-municipalities">
                        <header class="flex items-center justify-between p-3 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wider">Kommuner</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </header>
                        <content class="p-2 bg-white border-t border-slate-50">
                            <div id="municipalityFilters" class="space-y-1 max-h-48 overflow-y-auto pr-1"></div>
                        </content>
                    </div>

                    <!-- Stad -->
                    <div class="filter-section border border-slate-100 rounded-lg overflow-hidden" id="section-cities">
                        <header class="flex items-center justify-between p-3 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wider">Städer</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </header>
                        <content class="p-2 bg-white border-t border-slate-50">
                            <div id="cityFilters" class="space-y-1 max-h-48 overflow-y-auto pr-1"></div>
                        </content>
                    </div>

                    <!-- Ägare -->
                    <div class="filter-section border border-slate-100 rounded-lg overflow-hidden" id="section-owners">
                        <header class="flex items-center justify-between p-3 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wider">Ägare</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </header>
                        <content class="p-2 bg-white border-t border-slate-50">
                            <div id="ownerFilters" class="space-y-1 max-h-48 overflow-y-auto pr-1"></div>
                        </content>
                    </div>

                    <!-- Koncept -->
                    <div class="filter-section border border-slate-100 rounded-lg overflow-hidden" id="section-concepts">
                        <header class="flex items-center justify-between p-3 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wider">Koncept</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </header>
                        <content class="p-2 bg-white border-t border-slate-50">
                            <div id="conceptFilters" class="space-y-1 max-h-48 overflow-y-auto pr-1"></div>
                        </content>
                    </div>
                </div>

                <button id="resetFilters" class="w-full text-[10px] font-black text-slate-400 hover:text-red-500 uppercase tracking-widest py-3 border-2 border-dashed border-slate-100 rounded-xl transition-all hover:border-red-100">
                    Nollställ alla filter
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0">
            <div id="map"></div>
            
            <div class="flex-1 bg-white border-t border-slate-200 flex flex-col min-h-0 shadow-inner">
                <div class="px-6 py-2 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Resultatlista</h2>
                    <span id="rowCount" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">0 butiker</span>
                </div>
                <div class="table-container">
                    <table class="w-full text-left border-collapse text-[12px]">
                        <thead class="sticky top-0 bg-white shadow-sm z-10 border-b border-slate-200">
                            <tr class="text-slate-500 uppercase text-[9px] font-black tracking-wider">
                                <th class="px-6 py-4">Butiksnamn</th>
                                <th class="px-6 py-4">Kommun</th>
                                <th class="px-6 py-4">Stad</th>
                                <th class="px-6 py-4">Ägare</th>
                                <th class="px-6 py-4">Koncept</th>
                                <th class="px-6 py-4">Gatuadress</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLzuX1BgTlHxwgd7QnVuA2aPLR8EKXMg89E2OWfHHIQ5OBgZTylykPUZ-LvGGxjkj1x_xCZcy3jLG3/pub?gid=0&single=true&output=csv';
        // En pålitlig källa för svenska kommungränser (används om datan inte redan har "Kommun")
        const GEOJSON_URL = 'https://raw.githubusercontent.com/Hasselberg/sweden-geojson/master/kommuner.geojson';
        
        let map, markersLayer;
        let allData = [];
        let filteredData = [];
        let activeFilters = {
            search: '',
            municipalities: new Set(),
            cities: new Set(),
            owners: new Set(),
            concepts: new Set()
        };

        function initMap() {
            map = L.map('map', { 
                zoomControl: false,
                preferCanvas: true 
            }).setView([62.0, 15.0], 5);
            
            L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; Stadia Maps &copy; OpenMapTiles'
            }).addTo(map);
            
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }

        function loadData() {
            // Ladda både CSV och GeoJSON (kommun-karta) parallellt för snabbhet
            const fetchCSV = new Promise((resolve, reject) => {
                Papa.parse(CSV_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (err) => reject(err)
                });
            });

            const fetchGeoJSON = fetch(GEOJSON_URL)
                .then(res => res.json())
                .catch(err => {
                    console.warn("Kunde inte ladda kommungränser. Appen fungerar ändå, men kan sakna kommunnamn.", err);
                    return null;
                });

            Promise.all([fetchCSV, fetchGeoJSON])
                .then(([csvData, geoJson]) => {
                    
                    allData = csvData.filter(row => {
                        const latRaw = (row['Latitude'] || '').replace(',', '.').trim();
                        const lngRaw = (row['Longitude'] || '').replace(',', '.').trim();
                        const lat = parseFloat(latRaw);
                        const lng = parseFloat(lngRaw);
                        
                        // Filtrera bort trasiga koordinater (vilket förhindrar Turf.js krascher!)
                        const hasCoords = !isNaN(lat) && !isNaN(lng);
                        const isNotClosed = (row['Close Date'] || '').toLowerCase().trim() === '' || (row['Close Date'] || '').toLowerCase().trim() === 'n/a';
                        
                        return hasCoords && isNotClosed;
                    }).map(row => {
                        const lat = parseFloat(row['Latitude'].replace(',', '.'));
                        const lng = parseFloat(row['Longitude'].replace(',', '.'));
                        
                        // Om kolumnen redan finns i CSV används den först
                        let mun = row['Kommun'] || row['Municipality'] || '';
                        
                        // Om kommun saknas - Räkna ut den via Turf.js!
                        if (!mun && geoJson) {
                            try {
                                const pt = turf.point([lng, lat]);
                                const match = geoJson.features.find(f => turf.booleanPointInPolygon(pt, f));
                                if (match && match.properties) {
                                    mun = match.properties.name || match.properties.kommunnamn || match.properties.KOMMUNNAMN || match.properties.namn || '';
                                }
                            } catch(e) { /* Tyst felsökning om en enskild punkt bråkar */ }
                        }

                        return {
                            name: row['Display Name'] || row['Store ID'] || 'Okänd butik',
                            city: row['City'] || 'Saknas',
                            municipality: mun || 'Saknas',
                            owner: row['Owner'] || 'Övriga',
                            concept: row['Concept'] || 'N/A',
                            address: row['Address'] || '',
                            lat: lat,
                            lng: lng,
                            raw: row
                        };
                    });

                    setupFilters();
                    updateUI();
                    document.getElementById('loader').classList.add('hidden');
                })
                .catch(err => {
                    console.error("Kritiskt fel vid inläsning:", err);
                    alert("Kunde inte ladda data. Kontrollera nätverksanslutningen.");
                    document.getElementById('loader').classList.add('hidden');
                });
        }

        function setupFilters() {
            createCheckboxFilter('municipalityFilters', allData.map(d => d.municipality), activeFilters.municipalities);
            createCheckboxFilter('cityFilters', allData.map(d => d.city), activeFilters.cities);
            createCheckboxFilter('ownerFilters', allData.map(d => d.owner), activeFilters.owners);
            createCheckboxFilter('conceptFilters', allData.map(d => d.concept), activeFilters.concepts);

            document.getElementById('searchInput').addEventListener('input', (e) => {
                activeFilters.search = e.target.value.toLowerCase();
                updateUI();
            });

            document.querySelectorAll('.filter-section header').forEach(header => {
                header.onclick = () => header.parentElement.classList.toggle('active');
            });

            document.getElementById('resetFilters').onclick = () => {
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                activeFilters.municipalities.clear();
                activeFilters.cities.clear(); 
                activeFilters.owners.clear(); 
                activeFilters.concepts.clear();
                document.getElementById('searchInput').value = '';
                activeFilters.search = '';
                updateUI();
                map.setView([62.0, 15.0], 5);
            };

            document.getElementById('downloadExcel').onclick = exportExcel;
        }

        function createCheckboxFilter(containerId, items, filterSet) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Rensa innan skapande
            const uniqueItems = [...new Set(items.filter(i => i && i !== 'Saknas'))].sort();
            
            uniqueItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 p-1.5 hover:bg-blue-50 rounded-md cursor-pointer transition-colors group';
                div.innerHTML = `
                    <input type="checkbox" id="${containerId}-${item}" class="h-3.5 w-3.5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                    <label for="${containerId}-${item}" class="text-[11px] font-medium text-slate-600 truncate cursor-pointer flex-1 group-hover:text-blue-700">${item}</label>
                `;
                div.querySelector('input').onchange = (e) => {
                    if (e.target.checked) filterSet.add(item);
                    else filterSet.delete(item);
                    updateUI();
                };
                container.appendChild(div);
            });
        }

        function updateUI() {
            filteredData = allData.filter(d => {
                const matchesSearch = !activeFilters.search || 
                    (d.name + d.address + d.city + d.municipality + d.owner).toLowerCase().includes(activeFilters.search);
                const matchesMunicipality = activeFilters.municipalities.size === 0 || activeFilters.municipalities.has(d.municipality);
                const matchesCity = activeFilters.cities.size === 0 || activeFilters.cities.has(d.city);
                const matchesOwner = activeFilters.owners.size === 0 || activeFilters.owners.has(d.owner);
                const matchesConcept = activeFilters.concepts.size === 0 || activeFilters.concepts.has(d.concept);
                
                return matchesSearch && matchesMunicipality && matchesCity && matchesOwner && matchesConcept;
            });

            renderMarkers();
            renderTable();
            
            const countText = `${filteredData.length} butiker`;
            document.getElementById('stats').innerText = countText;
            document.getElementById('rowCount').innerText = countText;
        }

        function renderMarkers() {
            markersLayer.clearLayers();
            
            filteredData.forEach(d => {
                if (isNaN(d.lat) || isNaN(d.lng)) return;

                const marker = L.circleMarker([d.lat, d.lng], {
                    radius: 5, 
                    fillColor: "#2563eb", 
                    color: "#fff", 
                    weight: 1.5, 
                    fillOpacity: 0.8
                });
                
                const popupContent = `
                    <div class="p-2 min-w-[150px]">
                        <p class="text-[9px] font-black text-blue-600 uppercase tracking-tighter mb-0.5">${d.owner}</p>
                        <h3 class="font-bold text-slate-800 text-sm leading-tight mb-1">${d.name}</h3>
                        <p class="text-xs text-slate-500 mb-2">${d.address}<br/>${d.city} <span class="text-slate-400">(${d.municipality}s kommun)</span></p>
                        <div class="flex items-center gap-1">
                            <span class="bg-slate-100 text-[10px] px-1.5 py-0.5 rounded font-bold text-slate-600">${d.concept}</span>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent, { closeButton: false });
                markersLayer.addLayer(marker);
            });

            if (filteredData.length > 0 && filteredData.length < allData.length) {
                try {
                    const group = new L.featureGroup(markersLayer.getLayers());
                    if (group.getLayers().length > 0) {
                        map.fitBounds(group.getBounds(), { padding: [50, 50], maxZoom: 13 });
                    }
                } catch(e) { console.error(e); }
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const displayLimit = 200;
            const toDisplay = filteredData.slice(0, displayLimit);

            toDisplay.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50/50 cursor-pointer transition-colors group';
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-900 group-hover:text-blue-700">${d.name}</div>
                        <div class="text-[10px] text-slate-400 font-medium">ID: ${d.raw['Store ID'] || '-'}</div>
                    </td>
                    <td class="px-6 py-4 text-slate-600 font-medium">${d.municipality}</td>
                    <td class="px-6 py-4 text-slate-600">${d.city}</td>
                    <td class="px-6 py-4 text-slate-600 italic">${d.owner}</td>
                    <td class="px-6 py-4">
                        <span class="bg-slate-100 px-2 py-1 rounded-md text-[10px] font-bold text-slate-500 border border-slate-200">${d.concept}</span>
                    </td>
                    <td class="px-6 py-4 text-slate-500">${d.address}</td>
                `;
                tr.onclick = () => {
                    if (!isNaN(d.lat) && !isNaN(d.lng)) {
                        map.setView([d.lat, d.lng], 15);
                        markersLayer.eachLayer(m => {
                            if (m.getLatLng().lat === d.lat && m.getLatLng().lng === d.lng) {
                                m.openPopup();
                            }
                        });
                    }
                };
                tbody.appendChild(tr);
            });

            if (filteredData.length > displayLimit) {
                const infoRow = document.createElement('tr');
                infoRow.innerHTML = `<td colspan="6" class="px-6 py-4 text-center text-slate-400 italic text-[11px]">Visar de första ${displayLimit} butikerna. Använd sök eller filter för att hitta specifika objekt.</td>`;
                tbody.appendChild(infoRow);
            }
        }

        // Riktig Excel export (.xlsx) med SheetJS
        function exportExcel() {
            if (filteredData.length === 0) return;
            
            // Forma om datan. Om vi räknade ut kommunen själva lägger vi till den i Excel-datan
            const exportData = filteredData.map(d => {
                let row = { ...d.raw }; // Ta all originaldata från Google Sheets
                if (!row['Kommun'] && !row['Municipality']) {
                    row['Kommun'] = d.municipality; // Skjut in den beräknade kommunen som en ny kolumn
                }
                return row;
            });

            // Konvertera till Excel-format
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Filtrerade Butiker");
            
            // Ladda ner som riktig .xlsx-fil
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `butiksanalys_${dateStr}.xlsx`);
        }

        window.onload = () => {
            initMap();
            loadData();
        };
    </script>
</body>
</html>
