<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Butikskarta - Stabil Version</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- PapaParse för CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        #map { height: 45vh; width: 100%; z-index: 1; }
        .sidebar { height: calc(100vh - 64px); overflow-y: auto; }
        .table-container { height: 50vh; overflow: auto; }
        
        .filter-section content { display: none; }
        .filter-section.active content { display: block; }
        .filter-section.active header svg { transform: rotate(180deg); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 antialiased overflow-hidden">

    <div id="loader" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4"></div>
            <p class="text-slate-600 font-medium italic">Laddar butiksdata...</p>
        </div>
    </div>

    <nav class="bg-slate-900 text-white h-16 px-6 flex items-center justify-between shadow-lg relative z-[1001]">
        <div class="flex items-center space-x-3">
            <div class="bg-blue-600 p-1.5 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                </svg>
            </div>
            <h1 class="text-lg font-bold tracking-tight uppercase italic">Butikskarta <span class="text-blue-400 font-light not-italic">Pro</span></h1>
        </div>
        <div class="flex items-center space-x-4">
            <div id="stats" class="hidden md:block text-sm font-medium bg-slate-800 px-4 py-1.5 rounded-full border border-slate-700 italic">
                Laddar...
            </div>
            <button id="downloadCsv" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-full text-xs font-bold transition-colors">
                Exportera CSV
            </button>
        </div>
    </nav>

    <div class="flex flex-col md:flex-row h-screen">
        <!-- Sidebar / Filter -->
        <aside class="w-full md:w-72 bg-white border-r border-slate-200 sidebar z-[1000]">
            <div class="p-4 space-y-6">
                
                <section>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Sök butik</label>
                    <input type="text" id="searchInput" placeholder="Namn eller adress..." 
                        class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
                </section>

                <div class="space-y-3">
                    <!-- Stad -->
                    <div class="filter-section active border border-slate-100 rounded-lg overflow-hidden" id="section-cities">
                        <header class="flex items-center justify-between p-3 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wider">Stad</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </header>
                        <content class="p-2 bg-white border-t border-slate-50">
                            <div id="cityFilters" class="space-y-1 max-h-40 overflow-y-auto pr-1"></div>
                        </content>
                    </div>

                    <!-- Ägare -->
                    <div class="filter-section border border-slate-100 rounded-lg overflow-hidden" id="section-owners">
                        <header class="flex items-center justify-between p-3 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wider">Ägare</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </header>
                        <content class="p-2 bg-white border-t border-slate-50">
                            <div id="ownerFilters" class="space-y-1 max-h-40 overflow-y-auto pr-1"></div>
                        </content>
                    </div>

                    <!-- Koncept -->
                    <div class="filter-section border border-slate-100 rounded-lg overflow-hidden" id="section-concepts">
                        <header class="flex items-center justify-between p-3 bg-slate-50 cursor-pointer hover:bg-slate-100 transition-colors">
                            <span class="text-[10px] font-bold text-slate-600 uppercase tracking-wider">Koncept</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </header>
                        <content class="p-2 bg-white border-t border-slate-50">
                            <div id="conceptFilters" class="space-y-1 max-h-40 overflow-y-auto pr-1"></div>
                        </content>
                    </div>
                </div>

                <button id="resetFilters" class="w-full text-[11px] font-bold text-slate-400 hover:text-red-500 uppercase tracking-widest py-2 transition-colors">
                    Återställ alla filter
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0">
            <div id="map"></div>
            
            <div class="flex-1 bg-white border-t border-slate-200 flex flex-col min-h-0 shadow-inner">
                <div class="px-6 py-2 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Urval</h2>
                    <span id="rowCount" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded">0 rader</span>
                </div>
                <div class="table-container">
                    <table class="w-full text-left border-collapse text-[12px]">
                        <thead class="sticky top-0 bg-white shadow-sm z-10 border-b border-slate-100">
                            <tr class="text-slate-400 uppercase text-[10px] font-bold">
                                <th class="px-6 py-3">Butiksnamn</th>
                                <th class="px-6 py-3">Stad</th>
                                <th class="px-6 py-3">Ägare</th>
                                <th class="px-6 py-3">Koncept</th>
                                <th class="px-6 py-3">Adress</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLzuX1BgTlHxwgd7QnVuA2aPLR8EKXMg89E2OWfHHIQ5OBgZTylykPUZ-LvGGxjkj1x_xCZcy3jLG3/pub?gid=0&single=true&output=csv';
        
        let map, markersLayer;
        let allData = [];
        let filteredData = [];
        let activeFilters = {
            search: '',
            cities: new Set(),
            owners: new Set(),
            concepts: new Set()
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([62.0, 15.0], 5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    allData = results.data.filter(row => {
                        const hasLat = row['Latitude'] && row['Latitude'].trim() !== '';
                        const closeDate = (row['Close Date'] || '').toLowerCase().trim();
                        // Filtrera bort stängda butiker och de utan koordinater
                        return hasLat && (closeDate === '' || closeDate === 'n/a');
                    }).map(row => ({
                        name: row['Display Name'] || row['Store ID'] || 'Namnlös',
                        city: row['City'] || 'N/A',
                        owner: row['Owner'] || 'N/A',
                        concept: row['Concept'] || 'Övrigt',
                        address: row['Address'] || '',
                        lat: parseFloat(row['Latitude'].replace(',', '.')),
                        lng: parseFloat(row['Longitude'].replace(',', '.')),
                        raw: row
                    }));

                    setupFilters();
                    updateUI();
                    document.getElementById('loader').classList.add('hidden');
                },
                error: function() {
                    alert("Kunde inte hämta data från Google Sheets.");
                }
            });
        }

        function setupFilters() {
            // Skapa checkboxar för filter
            createCheckboxFilter('cityFilters', allData.map(d => d.city), activeFilters.cities);
            createCheckboxFilter('ownerFilters', allData.map(d => d.owner), activeFilters.owners);
            createCheckboxFilter('conceptFilters', allData.map(d => d.concept), activeFilters.concepts);

            // Sök-input
            document.getElementById('searchInput').addEventListener('input', (e) => {
                activeFilters.search = e.target.value.toLowerCase();
                updateUI();
            });

            // Accordion-logik
            document.querySelectorAll('.filter-section header').forEach(header => {
                header.onclick = () => header.parentElement.classList.toggle('active');
            });

            // Reset
            document.getElementById('resetFilters').onclick = () => {
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                activeFilters.cities.clear(); activeFilters.owners.clear(); activeFilters.concepts.clear();
                document.getElementById('searchInput').value = '';
                activeFilters.search = '';
                updateUI();
            };

            // Export
            document.getElementById('downloadCsv').onclick = exportCsv;
        }

        function createCheckboxFilter(containerId, items, filterSet) {
            const container = document.getElementById(containerId);
            const uniqueItems = [...new Set(items)].sort();
            
            uniqueItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 p-1 hover:bg-slate-50 rounded cursor-pointer';
                div.innerHTML = `
                    <input type="checkbox" id="${item}" class="h-3 w-3 rounded text-blue-600 border-slate-300">
                    <label for="${item}" class="text-[11px] text-slate-600 truncate cursor-pointer flex-1">${item}</label>
                `;
                div.querySelector('input').onclick = (e) => {
                    if (e.target.checked) filterSet.add(item);
                    else filterSet.delete(item);
                    updateUI();
                };
                container.appendChild(div);
            });
        }

        function updateUI() {
            filteredData = allData.filter(d => {
                const matchesSearch = !activeFilters.search || 
                    (d.name + d.address + d.city).toLowerCase().includes(activeFilters.search);
                const matchesCity = activeFilters.cities.size === 0 || activeFilters.cities.has(d.city);
                const matchesOwner = activeFilters.owners.size === 0 || activeFilters.owners.has(d.owner);
                const matchesConcept = activeFilters.concepts.size === 0 || activeFilters.concepts.has(d.concept);
                
                return matchesSearch && matchesCity && matchesOwner && matchesConcept;
            });

            renderMarkers();
            renderTable();
            document.getElementById('stats').innerText = `${filteredData.length} butiker hittade`;
            document.getElementById('rowCount').innerText = `${filteredData.length} rader`;
        }

        function renderMarkers() {
            markersLayer.clearLayers();
            filteredData.forEach(d => {
                const marker = L.circleMarker([d.lat, d.lng], {
                    radius: 5, fillColor: "#2563eb", color: "#fff", weight: 1, fillOpacity: 0.8
                });
                marker.bindPopup(`<div class="p-1"><b class="text-sm">${d.name}</b><br><span class="text-xs text-slate-500">${d.address}</span></div>`);
                markersLayer.addLayer(marker);
            });

            if (filteredData.length > 0 && (activeFilters.cities.size > 0 || activeFilters.search !== '')) {
                const group = new L.featureGroup(markersLayer.getLayers());
                map.fitBounds(group.getBounds(), { padding: [40, 40], maxZoom: 12 });
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            filteredData.forEach(d => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50/50 cursor-pointer transition-colors';
                tr.innerHTML = `
                    <td class="px-6 py-3 font-bold text-slate-800">${d.name}</td>
                    <td class="px-6 py-3 text-slate-600">${d.city}</td>
                    <td class="px-6 py-3 text-slate-600">${d.owner}</td>
                    <td class="px-6 py-3"><span class="bg-slate-100 px-2 py-0.5 rounded text-[10px] font-bold text-slate-500">${d.concept}</span></td>
                    <td class="px-6 py-3 text-slate-500">${d.address}</td>
                `;
                tr.onclick = () => {
                    map.setView([d.lat, d.lng], 14);
                };
                tbody.appendChild(tr);
            });
        }

        function exportCsv() {
            const csv = Papa.unparse(filteredData.map(d => d.raw));
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `butiksexport_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        window.onload = () => {
            initMap();
            loadData();
        };
    </script>
</body>
</html>
